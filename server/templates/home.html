{% extends "layout.html" %}

{% block main %}
 <!-- Removed inline styles -->
 <link rel="stylesheet" href="./static/styles.css">
 
 <body>
 <div class="home-container">
    <div class="title-container">
        <div class="entry-title">"Maximizing your voter power in 2024 and preserving democracy."</div>
        <!-- <div class="main-title">Vote Maximizer</div>-->
        <hr>
        <div class="main-title">Vote Maximizer</div>
        <div class="container" id="fieldset-container">
            <div class="flex-container">
                <form action="/local" method="post">
                    <label for="location">Find pivotal elections near you:</label>
                    <input type="text" class="form-control" id="location" name="location" placeholder="type address/ZIP, press enter">
                </form>
            </div>
        </div>
    </div>

<div class="map-container">
    <div class="col" id="map"></div>
</div>
<div class="legend-container">
    <div id="legend" class="legend">
        <div id="color-scale">
            <div class="legend-items">
                <button class="legend-btn" data-level="democracy" style="background-color: #9277DE;">
                    Democracy
                </button>
            </div>
            
            <div class="legend-items">
                <button class="legend-btn" data-level="president" style="background-color: #F5928D;">
                    President
                </button>
            </div>
            
            <div class="legend-items">
                <button class="legend-btn" data-level="congress" style="background-color: #B4CDE3;">
                    Congress
                </button>
            </div>  

            <div class="legend-items">
                <button class="legend-btn" data-level="state" style="background-color: #D19E9B;">
                    State Elections
                </button>
            </div>
            
            <div class="legend-items">
                <button class="legend-btn" data-level="abortion" style="background-color: #F768A0;">
                    Abortion
                </button>
            </div>
            
            <div class="legend-items">
                <button class="legend-btn" data-level="key_ballot" style="background-color: #13DDB7;">
                     Ballot Measures
                </button>
            </div> 
        </div>
    </div>
</div>

<script type="module">    
        // Add this near the top of your <script> tag
        import voterEmpowerment from './static/js/voter_empowerment.js';
        const LEVELS = ['democracy', 'president', 'congress', 'state', 'abortion', 'key_ballot']
        let animationRunning = true;
        console.log(voterEmpowerment);
        const COLOR_BG = '#F2F3F4';  // Define your background color
        const COLOR_HOVER = '#FFFFFF';
        const COLOR_DEMOCRACY = '#9277DE';
        const COLOR_PRESIDENT = '#F5928D';
        const COLOR_CONGRESS = '#B4CDE3';
        const COLOR_GOVERNOR = '#13DDB7';
        const COLOR_STATE_LEGISLATURE = '#D19E9B';
        const COLOR_ABORTION = '#F768A0';
        const COLOR_KEY_BALLOT = '#13DDB7';
        const COLOR_DEFAULT  = '#D3D3D3'; // Default color for unmatched cases
        const BORDER_COLOR = '#EEEEEE'; // Border color for all layers

        const democracyScale = interpolateColors(COLOR_DEFAULT, COLOR_DEMOCRACY, 5);
    
        const presidentScale = interpolateColors(COLOR_DEFAULT, COLOR_PRESIDENT, 5);
        const congressScale = interpolateColors(COLOR_DEFAULT, COLOR_CONGRESS, 5)
        const govScale = interpolateColors(COLOR_DEFAULT, COLOR_GOVERNOR, 5)
        const stateLegScale = interpolateColors(COLOR_DEFAULT, COLOR_STATE_LEGISLATURE, 5) 
        const abortionScale = interpolateColors(COLOR_DEFAULT, COLOR_ABORTION, 5)
        const keyBallotScale = interpolateColors(COLOR_DEFAULT, COLOR_KEY_BALLOT, 5)

        console.log('key ballot scale  ', keyBallotScale);
        // Set the background color of the body
        document.body.style.backgroundColor = COLOR_BG;
        mapboxgl.accessToken = '{{ mapbox_key }}';
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mikeklein1/cm0h4ib4o01mf01qv90n802b8/draft',
            zoom: 3.5, // Adjust as needed
            maxZoom: 4,
            minZoom: 2,
            center: [0,-2],
            projection: 'mercator', // Using an equal-area projection,
            background: COLOR_BG  // Use the same color for the map background
        });
        // Function to interpolate between two colors
        function interpolateColor(color1, color2, factor) {
            const result = color1.slice();
            for (let i = 0; i < 3; i++) {
                result[i] = Math.round(result[i] + factor * (color2[i] - color1[i]));
            }
            return result;
        }
        // Function to convert hex to RGB
        function hexToRgb(hex) {
            const bigint = parseInt(hex.slice(1), 16);
            return [(bigint >> 16) & 255, (bigint >> 8) & 255, bigint & 255];
        }
        // Function to convert RGB to hex
        function rgbToHex(rgb) {
            return "#" + rgb.map(x => {
                const hex = x.toString(16);
                return hex.length === 1 ? "0" + hex : hex;
            }).join('');
        }

        // Combined function for both cases
        function interpolateColors(startColor, endColor, steps, extendRange = false) {
            const start = hexToRgb(startColor);
            const end = hexToRgb(endColor);
            const colors = [];

            if (extendRange) {
                // Case 2: Create a darker version of the end color
                const darkerEnd = end.map(c => Math.max(0, c - 40));
                steps += 1; // Add an extra step for the darker color

                for (let i = 0; i < steps; i++) {
                    const factor = i / (steps - 1);
                    const interpolated = i === steps - 1 
                        ? darkerEnd 
                        : interpolateColor(start, end, factor);
                    colors.push(rgbToHex(interpolated));
                }
            } else {
                // Case 1: Standard interpolation
                for (let i = 0; i < steps; i++) {
                    const factor = i / (steps - 1);
                    const interpolated = interpolateColor(start, end, factor);
                    colors.push(rgbToHex(interpolated));
                }
            }

            return colors;
        }

        //add all the layers as const here
        const layers = {
            starting: 'static/data/calculated_files/geojsons/overall_albers.geojson',
            overall: 'static/data/calculated_files/geojsons/overall_albers.geojson',
            aggregate: 'static/data/calculated_files/geojsons/aggregate_albers.geojson',
            presidential: 'static/data/calculated_files/geojsons/president_albers.geojson',
            congressional: 'static/data/calculated_files/geojsons/senate_albers.geojson',
            house: 'static/data/geojson_imports/geojson_final/house_albers.geojson',
            gubernatorial: 'static/data/calculated_files/geojsons/governor_albers.geojson',
            ballot_all: 'static/data/geojson_imports/geojson_final/ballot_initiatives_main_albers.geojson',
            state_leg_up:'static/data/geojson_imports/geojson_final/state_leg_upper_albers.geojson',
            state_leg_low:'static/data/geojson_imports/geojson_final/state_leg_lower_albers.geojson'
            
        };

        const geoJsonCache = {};

        async function loadGeoJson(layerId) {
            if (geoJsonCache[layerId]) {
                return geoJsonCache[layerId];
            }
            const startTime = performance.now();
            try {
                const response = await fetch(layers[layerId]);
                const data = await response.json();
                geoJsonCache[layerId] = data;
                
                const endTime = performance.now();
                const downloadTime = (endTime - startTime) / 1000; // Convert to seconds
                
                return data;
            } catch (error) {
                throw error;
            }
        }
        //this is just the color for the legend
    function updateLegend(layerId) {
        var gradient = '';
        var legendElement = document.getElementById('legend');
        
        if (layerId === 'overall') {
            legendElement.style.display = 'none';  // Hide the entire legend
            return;  // Exit the function early
        }
        
        // If we're here, it's not the 'overall' layer, so show the legend
        legendElement.style.display = 'block';
        
        switch(layerId) {
            case 'presidential':
                gradient = `linear-gradient(to right, ${presidentScale.join(', ')})`;
                break;
            case 'congressional':
                gradient = `linear-gradient(to right, ${congressScale.join(', ')})`;
                break;
            case 'house':
                gradient = `linear-gradient(to right, ${congressScale.join(', ')})`;
                break;
            case 'gubernatorial':
                gradient = `linear-gradient(to right, ${govScale.join(', ')})`;
                break;
            case 'ballot_all':
                gradient = 'linear-gradient(to right, #c7eae5, #01665e)'; 
                legendTitle = 'Ballot initiative number';
                break;
            case 'state_leg_up':
                gradient = `linear-gradient(to right, ${stateLegScale.join(', ')})`; 
                break;
            case 'state_leg_low':
                gradient = `linear-gradient(to right, ${stateLegScale.join(', ')})`; 
                break;
            default:
                gradient = 'none';  // No gradient for layers without Voter.Power
        }
        document.getElementById('color-scale').style.background = gradient;
    }

        let hoveredStateId = null; // This will hold the ID of the feature under the mouse.
        let currentLayerId = 'overall'; // adjust the layer that pops up first here

        const popup = new mapboxgl.Popup({
            closeButton: false,
            closeOnClick: false
        });
        

        function addGeoJsonLayer(layerId) {
            const idProperty = layerId === 'house' || layerId === 'state_leg_up' || layerId === 'state_leg_low' ? 'GEOIDFQ' : 'STATEFP';  //  'house' uses GEOIDFQ, others use STATEFP for unique id

            // remove hover state when switching layers
            if (hoveredStateId) {
                map.setFeatureState({source: currentLayerId, id: hoveredStateId}, { hover: false });
                hoveredStateId = null;
            }

            // Remove existing layers
            if (map.getSource(currentLayerId)) {
                map.removeLayer(currentLayerId + '-fill');
                map.removeLayer(currentLayerId + '-line');
                map.removeLayer(currentLayerId + '-hover-line');  // Remove hover line if it exists
                map.removeSource(currentLayerId);

                console.log('Layer removed:', currentLayerId);
            }

            // Adds the geojson layers
            map.addSource(layerId, {
                type: 'geojson',
                data: layers[layerId],
                promoteId: idProperty  
            });
        
            console.log('Layer added:', layerId);
   
    if (layerId === 'ballot_all') {
        map.addLayer({
            id: layerId + '-fill',
            type: 'fill',
            source: layerId,
            filter: ['!=', ['get', 'STATEFP'], '72'], // Exclude Puerto Rico
            paint: {
            'fill-color': [
                'case',
                ['==', ['get', 'number_per_state'], null], COLOR_DEFAULT, // If number_per_state is null, use grey
                ['==', ['get', 'number_per_state'], 0], COLOR_DEFAULT, // Also use grey if number_per_state is 0
        
                ['interpolate', ['linear'], 
                ['get', 'number_per_state'],
                1, keyBallotScale[0],
                2, keyBallotScale[1],
                3, keyBallotScale[2],
                4, keyBallotScale[3],
                5, keyBallotScale[4]
            ],
            ],
            'fill-opacity': 1, // 100% opaque
        }
        }, 'albersusa-points'); // state names should be over the layers
    } else if (layerId === 'starting') {
        map.addLayer({
            id: layerId + '-fill',
            type: 'fill',
            source: layerId,
            filter: ['!=', ['get', 'STATEFP'], '72'], // Exclude Puerto Rico
            paint: {
                'fill-color': COLOR_DEFAULT,
                'fill-opacity': 0,
            } 
        }, 'albersusa-points');
    } else if (layerId === 'overall') {
        map.addLayer({
            id: layerId + '-fill',
            type: 'fill',
            source: layerId,
            filter: ['!=', ['get', 'STATEFP'], '72'], // Exclude Puerto Rico
            paint: {
                    'fill-color': [
                        'match',
                        ['get', 'power_level'],
                        'democracy', COLOR_DEMOCRACY,  // Color for score 1
                        'president', COLOR_PRESIDENT,  // Color for score 2
                        'congress', COLOR_CONGRESS,  // Color for score 3
                        'governor', COLOR_GOVERNOR,  // Color for score 4
                        'state legislature', COLOR_STATE_LEGISLATURE,  // Color for score 5
                        COLOR_DEFAULT,    // Default color if no match
                    ],
                    'fill-opacity': 1,
                }
        }, 'albersusa-points'); // state names should be over the layers
    } else {

            map.addLayer({
    id: layerId + '-fill',
    type: 'fill',
    source: layerId,
    filter: ['!=', ['get', 'STATEFP'], '72'], // Exclude Puerto Rico
    paint: {
        'fill-color': [
            'case',
            ['==', ['get', 'voter_power'], null], COLOR_DEFAULT, //  undefined voter_power is grey
            ['==', ['get', 'voter_power'], 0], COLOR_DEFAULT, //  zero voter_power is also grey
            
            ['==', layerId, 'aggregate'], [
                'interpolate', ['linear'], ['get', 'voter_power'],
                1, '#ffffd4', 33.3, '#fed98e', 66.6, '#fe9929', 100, '#cc4c02'
            ],

            ['==', layerId, 'presidential'], [
                'interpolate', ['linear'], ['get', 'voter_power'],
                1, presidentScale[0],
                25, presidentScale[1],
                50, presidentScale[2],
                75, presidentScale[3],
                100, presidentScale[4]
            ],
            ['==', layerId, 'congressional'], [
                'interpolate', ['linear'], ['get', 'voter_power'],
                1, congressScale[0],
                25, congressScale[1],
                50, congressScale[2],
                75, congressScale[3],
                100, congressScale[4]
            ],
            ['==', layerId, 'house'], [
                'interpolate', ['linear'], ['get', 'voter_power'],
                1, congressScale[0],
                25, congressScale[1],
                50, congressScale[2],
                75, congressScale[3],
                100, congressScale[4]
            ],
            ['==', layerId, 'gubernatorial'], [
                'interpolate', ['linear'], ['get', 'voter_power'],
                1, govScale[0],
                25, govScale[1],
                50, govScale[2],
                75, govScale[3],
                100, govScale[4]
            ],
            ['==', layerId, 'state_leg_up'], [
                'interpolate', ['linear'], ['get', 'voter_power'],
                1, stateLegScale[0],
                25, stateLegScale[1],
                50, stateLegScale[2],
                75, stateLegScale[3],
                100, stateLegScale[4]
            ],
            ['==', layerId, 'state_leg_low'], [
                'interpolate', ['linear'], ['get', 'voter_power'],
                1, stateLegScale[0],
                25, stateLegScale[1],
                50, stateLegScale[2],
                75, stateLegScale[3],
                100, stateLegScale[4]
            ],
            COLOR_DEFAULT  // Default color for unmatched cases
        ],
        'fill-opacity': 1
    }

}, 'albersusa-points');
    }
            // line layer to seperate states or districts
            map.addLayer({
                id: layerId + '-line',
                type: 'line',
                source: layerId,
                layout: {},
                paint: {
                    'line-color': BORDER_COLOR,
                    'line-width': 1.5,
                    'line-opacity': 1
                }
            });

            // add line layer that highlights when hovering 
            map.addLayer({
                id: layerId + '-hover-line',
                filter: ['!=', ['get', 'STATEFP'], '72'], // Exclude Puerto Rico
                type: 'line',
                source: layerId,
                layout: {},
                paint: {
                    'line-color': ['case', ['boolean', ['feature-state', 'hover'], false], COLOR_HOVER, BORDER_COLOR],
                    'line-color-transition': { duration: 1000 },
                    'line-width': ['case', ['boolean', ['feature-state', 'hover'], false], 4, 2],
                    'line-opacity': ['case', ['boolean', ['feature-state', 'hover'], false], 1, 0],
                }
            });

            // put hover line  above others
            map.moveLayer(layerId + '-hover-line');

        map.on('click', layerId + '-fill', function (e) {
            //e.preventDefault(); 

            //test the geojson data
            const gData = map.querySourceFeatures(layerId);
            const geoData = map.getSource(layerId)._data;

            // test the feature.properties
            const features = map.queryRenderedFeatures(e.point);

            if (features.length) {
                features.forEach(feature => {
                    const layerName = feature.layer.id;
                    console.log(`Layer: ${layerName}`);
                    console.log('Feature Properties:', feature.properties);
                    
                    // You can process or display the data as needed
                });
            }


                const feature = e.features[0];
                const name = feature.properties['NAME'] || feature.properties['NAMELSAD'] || feature.properties['election_name'];
                const voterPower = feature.properties['voter_power'];
                const state = feature.properties['STATEFP'];
                const geoid = feature.properties['GEOIDFQ'];
                const usps_code = feature.properties['STUSPS'];
                const url = `/state?location=${feature.properties['state_name']}`;
                const url2 = `/local/${geoid}`;
       
                //alert("You clicked on " + name + " with a voter power of " + voterPower);
                
                console.log(url)
                window.location.href = url;
                //window.open(url, '_blank');
                //window.open(url, 'popup', 
                //    'width=800,height=600,scrollbars=yes,resizable=yes'); 
  
            });

            // mouse event for hovering
map.on('mousemove', layerId + '-fill', function (e) {
    if (e.features.length > 0) {
        const feature = e.features[0];
        const currentId = feature.properties[idProperty]; // Make sure this is the field you promote as ID

        //console.log("Feature ID:", feature.id, "Current ID:", currentId);  // Logging feature ID for debugging
        
        if (hoveredStateId !== currentId) {
            if (hoveredStateId) {
                map.setFeatureState({source: layerId, id: hoveredStateId}, { hover: false });
            }
            hoveredStateId = currentId;
            map.setFeatureState({source: layerId, id: hoveredStateId}, { hover: true });
        }

        let popupContent = ""; // Initialize popupContent
        const name = feature.properties['NAME'] || feature.properties['NAMELSAD'] || feature.properties['election_name'];
        let voterPower = feature.properties['voter_power']; // Directly use the property

        if (layerId === 'ballot_all') {
            // Check if the description is undefined or empty
            var description = feature.properties['number_per_state'];
            if (description === undefined || description === '') {
                popupContent = `<div class="custom-popup">
                    <strong>There are no democracy ballot initiatives in your state.</strong>
                </div>`;
            } else {
                popupContent = `<div class="custom-popup">
                    <strong>Number of ballot initiatives in your state: ${description}</strong> <br>Click on the state in the dropdown menu to learn about ballot initiatives in this state.
                </div>`;
            }
        } else if (layerId === 'congressional' && (voterPower === undefined || voterPower === 'no race')) {
            // Specific case for congressional layer with undefined voter power
            popupContent = `<div class="custom-popup">
                <strong>State: ${name}:</strong> <br>
                No race
            </div>`;
        } else if (layerId === 'overall') {
            // Handle overall case
            let powerLevel = feature.properties['power_level'];
            powerLevel = powerLevel[0].toUpperCase() + powerLevel.slice(1);
            popupContent = `<div class="custom-popup">
                <strong>State:</strong> ${name}<br>
                <strong>Power Level: ${powerLevel}</strong><br>
                <strong>Voter Power:</strong> ${voterPower}
            </div>`;
        }
        else {
            // Handle other cases
            voterPower = voterPower === undefined ? 'no competitive race' : voterPower; // Check if voter power is undefined
            popupContent = `<div class="custom-popup">
                <strong>${layerId === 'house' || layerId === 'state_leg_up' || layerId === 'state_leg_low' ? 'District' : 'State'}:</strong> ${name}<br>
                <strong>Voter Power:</strong> ${voterPower}
            </div>`;
        }
            
                    popup.setLngLat(e.lngLat).setHTML(popupContent).addTo(map);
                    map.getCanvas().style.cursor = 'pointer';
                } else {
                    if (hoveredStateId) {
                        map.setFeatureState({source: layerId, id: hoveredStateId}, { hover: false });
                        hoveredStateId = null;
                    }
                    map.getCanvas().style.cursor = '';
                    popup.remove();
                }
            });

            map.on('mouseleave', layerId + '-fill', function () {
                if (hoveredStateId) {
                    map.setFeatureState({source: layerId, id: hoveredStateId}, { hover: false });
                    hoveredStateId = null;
                }
                map.getCanvas().style.cursor = '';
                popup.remove();
            });

            // Update the current layer ID
            currentLayerId = layerId;
        }

map.on('load', async function () {
    map.scrollZoom.disable();
    try {
        const startingData = await loadGeoJson('starting');
        addGeoJsonLayer('starting', startingData);
        map.setPaintProperty('starting-fill', 'fill-color', COLOR_DEFAULT);
        console.log('Starting layer added to map.');

        // Lazy load other layers
        Object.keys(layers).forEach(layerId => {
            if (layerId !== 'starting') {
                loadGeoJson(layerId);
            }
        });
    } catch (error) {
        console.error('Error during initial map setup:', error);
    }

    // Set initial color for all states
    //map.setPaintProperty('starting-fill', 'fill-color', COLOR_DEFAULT);

    // Wait for the source to load
    map.once('idle', function() {   
        let animationId;
        let features = [];
        let allFeatures = [];
        let powerLevels = LEVELS;
        let currentPowerLevelIndex = 0;
        const animationDelay = 1000;
        const transitionDelay = 4000; // Increased delay between power levels
        const steps = 30;
        const stateColors = new Map();
        const stateOpacities = new Map();

        function queryFeatures() {
            allFeatures= map.queryRenderedFeatures({ layers: ['starting-fill'] });
            
            features = allFeatures.filter((feature, index, self) =>
                index === self.findIndex((t) => (
                    t.properties.STATEFP === feature.properties.STATEFP
                )) && feature.properties.power_level !== "none"
            );

            if (features.length > 0) {
                animateNextPowerLevel();
            } else {
                console.error("No features found. Retrying in 1 second...");
                setTimeout(queryFeatures, 1000);
            }
        }
        queryFeatures();

        async function animateNextPowerLevel() {
            if (!features || features.length === 0) {
                console.error("Features not loaded yet. Retrying in 1 second...");
                setTimeout(animateNextPowerLevel, 1000);
                return;
            }
            console.log("animateNextPowerLevel called.");
            if (currentPowerLevelIndex >= powerLevels.length) {
                currentPowerLevelIndex = 0;
            } 
                const currentPowerLevel = powerLevels[currentPowerLevelIndex];
                console.log("Animating power level: ", currentPowerLevel);
                
                const statesToAnimate = features.filter(feature => 
                    voterEmpowerment[currentPowerLevel].includes(feature.properties.STUSPS)
                );
                const targetColor = getColorForPowerLevel(currentPowerLevel);
                // Set all states to default fill-color
                allFeatures.forEach(feature => {
                    const stateId = feature.properties.STATEFP;
                    stateColors.set(stateId, COLOR_DEFAULT);
                    stateOpacities.set(stateId, 0); // Full opacity
                });
                updateMapColors();

                await animateStates(statesToAnimate, targetColor, true);
                currentPowerLevelIndex++;
                // Use Promise-based setTimeout
                await new Promise(resolve => setTimeout(resolve, transitionDelay));
                if (animationRunning) { 
                    animateNextPowerLevel(); // Continue to next power level
                }

        }

        function easeInOutQuad(t) {
            return t < 0.5 ? 2 * t * t : 1 - Math.pow(-2 * t + 2, 2) / 2;
        }

        function animateStates(states, targetColor,useLinearFade = false) {
            return new Promise((resolve) => {
                const opacityDelay = animationDelay / steps;
                
                states.forEach(feature => {
                    const stateId = feature.properties.STATEFP;
                    stateColors.set(stateId, targetColor);
                });
                
                for (let i = 0; i <= steps; i++) {
                    setTimeout(() => {
                        //adding one prevents ever being 0
                        const t = (i + 1) / (steps + 1);
                        const opacity = useLinearFade ? t : easeInOutQuad(t);
                        states.forEach(feature => {
                            const stateId = feature.properties.STATEFP;
                            stateOpacities.set(stateId, opacity);
                        });
                        updateMapColors();
                        if (i === steps) resolve(); // Resolve the promise when animation is complete
                    }, i * opacityDelay);
                }
            });
        }

        function updateMapColors() {
            const colorExpression = [
                'match',
                ['get', 'STATEFP'],
                ...Array.from(stateColors).flatMap(([statefp, color]) => [statefp, color]),
                COLOR_DEFAULT
            ];

            const opacityExpression = [
                'match',
                ['get', 'STATEFP'],
                ...Array.from(stateOpacities).flatMap(([statefp, opacity]) => [statefp, opacity]),
                0.1 // Default opacity for states not yet animated
            ];


            if (map.getLayer('starting-fill')) {
                map.setPaintProperty('starting-fill', 'fill-color', colorExpression);
                map.setPaintProperty('starting-fill', 'fill-opacity', opacityExpression);
            } else {
                console.error("Layer 'starting-fill' does not exist");
            }
        }

        function stopAnimation() {
            if (animationId) {
                clearTimeout(animationId);
            }
        }
    });
});

function getColorForPowerLevel(powerLevel) {
    switch(powerLevel) {
        case 'democracy': return COLOR_DEMOCRACY;
        case 'president': return COLOR_PRESIDENT;
        case 'congress': return COLOR_CONGRESS;
        case 'governor': return COLOR_GOVERNOR;
        case 'abortion': return COLOR_ABORTION;
        case 'key_ballot': return COLOR_KEY_BALLOT;
        case 'state': return COLOR_STATE_LEGISLATURE;
        default: return COLOR_DEFAULT;
    }
}

// Add click event listener for legend buttons
document.querySelectorAll('.legend-btn').forEach(button => {
    button.addEventListener('click', function() {
        //stop the animation
        animationRunning = false;
        const powerLevel = this.getAttribute('data-level');
        const color = getColorForPowerLevel(powerLevel);
        
        console.log("Power level clicked : ", powerLevel);
        // Remove active class from all buttons
        document.querySelectorAll('.legend-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Add active class to clicked button
        this.classList.add('active');
        
        // Filter the map to show only states with the selected power level
        // Change the layer to the one that is clicked
        if (powerLevel === 'democracy') {
            addGeoJsonLayer('overall');
        } else if (powerLevel === 'president') {
            addGeoJsonLayer('presidential');
        } else if (powerLevel === 'congress') {
            addGeoJsonLayer('congressional');
        } else if (powerLevel === 'state') {
            addGeoJsonLayer('state_leg_up');
        } else if (powerLevel === 'abortion') {
            addGeoJsonLayer('presidential');
        } else if (powerLevel === 'key_ballot') {
            addGeoJsonLayer('ballot_all');
        }
    });
});

document.getElementById('location').addEventListener('keypress', function (e) {
    if (e.key === 'Enter') {
        e.preventDefault(); // Prevent the default action (form submission)
        document.getElementById('local-elections-form').submit(); // Submit the form
    }
});
    </script>
</body>
{% endblock %}