{% extends "layout.html" %}

{% block main %}
<!-- Should shift this style to CSS sheet at some point-->
<style> 
    body { margin: 0; padding: 0;  }
    .map-overlay {
        font: 14px/20px 'Arial';
        position: absolute;
        top: 100px; /* need a dynamic solution to keep it not overlaying with other stuff */
        left: 10px;
        bottom: 10px;
        padding: 10px;
        z-index: 2; /* put over  map */
    }
    .map-overlay-inner {
        background-color: #fff;
        padding: 10px;
        border-radius: 3px;
    }
    .map-overlay-inner fieldset {
        border: none;
        padding: 0;
        margin: 0 0 10px;
    }
    .map-overlay-inner fieldset:last-child {
        margin: 0;
    }
    .map-overlay-inner select {
        width: 100%;
    }
    .map-overlay-inner label {
        display: block;
        font-weight: bold;
        margin: 0 0 5px;
    }
    .map-overlay-inner button {
        display: inline-block;
        width: 20px;
        height: 5px;
        border: none;
        cursor: pointer;
    }
    .map-overlay-inner button:focus {
        outline: none;
    }
    .custom-popup {
        font-size: 16px;
        padding: 10px;
        width: 200px;
        color: #333;
        margin: 0px;
        
    }
</style>

<body>
    <div class="map-overlay">
        <div class="map-overlay-inner">
            <div id="geocoder" class="geocoder"></div>
            <fieldset>
                <label for="layer">Which races are the most competitive? </label>
                <select id="layer" name="layer">
                    <option value="presidential" selected>Presidential race</option>
                    <option value="congressional">Senate race</option>
                    <option value="house">House race</option>
                    <option value="gubernatorial">Gubernatorial race</option>
                    <option value="ballot_initiatives">Ballot initiatives</option>
                </select>
            </fieldset>
        </div>
    </div>
    <div class="col" id="map"></div>

    <script>
        mapboxgl.accessToken = '{{ mapbox_key }}';
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mikeklein1/clxkrmlob01s801qkb96q6c00',
            center: [-98.625126, 37.718862],
            zoom: 3.4,
            projection: 'globe'
        });

        const layers = {
            presidential: 'static/data/Presidential_power.geojson',
            congressional: 'static/data/Congressional_power.geojson',
            house: 'static/data/2024.house.VoterPower.geojson'
        };

        let hoveredStateId = null; // This will hold the ID of the feature under the mouse.
        let currentLayerId = 'presidential'; // Track the current layer

        const popup = new mapboxgl.Popup({
            closeButton: false,
            closeOnClick: false
        });

        function addGeoJsonLayer(layerId) {
            const idProperty = layerId === 'house' ? 'GEOIDFQ' : 'STATEFP';  //  'house' uses GEOIDFQ, others use STATEFP for unique id

            // Clear hover state when switching layers
            if (hoveredStateId) {
                map.setFeatureState({source: currentLayerId, id: hoveredStateId}, { hover: false });
                hoveredStateId = null;
            }

            // Remove existing layers
            if (map.getSource(currentLayerId)) {
                map.removeLayer(currentLayerId + '-fill');
                map.removeLayer(currentLayerId + '-line');
                map.removeLayer(currentLayerId + '-hover-line');  // Remove hover line if it exists
                map.removeSource(currentLayerId);
            }

            // Add  layers
            map.addSource(layerId, {
                type: 'geojson',
                data: layers[layerId],
                promoteId: idProperty  
            });

            map.addLayer({
                id: layerId + '-fill',
                type: 'fill',
                source: layerId,
                paint: {
                    'fill-color': [
                        'case',
                        ['==', ['typeof', ['get', 'Voter.Power']], 'number'],
                        {
                            'presidential': [
                                'interpolate', ['linear'], ['get', 'Voter.Power'],
                                1, '#feedde', 10, '#fdbe85', 50, '#fd8d3c', 100, '#d94701'
                            ],
                            'congressional': [
                                'interpolate', ['linear'], ['get', 'Voter.Power'],
                                1, '#f2f0f7', 25, '#cbc9e2', 50, '#9e9ac8', 100, '#6a51a3'
                            ],
                            'house': [
                                'interpolate', ['linear'], ['get', 'Voter.Power'],
                                1, '#edf8e9', 10, '#bae4b3', 50, '#74c476', 100, '#238b45'
                            ]
                        }[layerId],
                        '#D3D3D3'  // Color for Nas
                    ],
                    'fill-opacity': 1
                }
            });

            // line layer should be black as default
            map.addLayer({
                id: layerId + '-line',
                type: 'line',
                source: layerId,
                layout: {},
                paint: {
                    'line-color': '#000',
                    'line-width': 2,
                    'line-opacity': 1
                }
            });

            // add line layer that highlights when hovering 
            map.addLayer({
                id: layerId + '-hover-line',
                type: 'line',
                source: layerId,
                layout: {},
                paint: {
                    'line-color': ['case', ['boolean', ['feature-state', 'hover'], false], '#ffffff', '#000'],
                    'line-width': ['case', ['boolean', ['feature-state', 'hover'], false], 4, 2],
                    'line-opacity': ['case', ['boolean', ['feature-state', 'hover'], false], 1, 0]
                }
            });

            // put hover line  above others
            map.moveLayer(layerId + '-hover-line');

            // mouse event for hovering
            map.on('mousemove', layerId + '-fill', function (e) {
                if (e.features.length > 0) {
                    const feature = e.features[0];
                    const currentId = feature.properties[idProperty];  // Make sure this is the field you promote as ID

                   // console.log("Feature ID:", feature.id, "Current ID:", currentId);  // Logging feature ID for debugging

                    if (hoveredStateId !== currentId) {
                        if (hoveredStateId) {
                            map.setFeatureState({source: layerId, id: hoveredStateId}, { hover: false });
                        }
                        hoveredStateId = currentId;
                        map.setFeatureState({source: layerId, id: hoveredStateId}, { hover: true });
                    }

                    const name = feature.properties['NAME'] || feature.properties['NAMELSAD'];
                    const voterPower = feature.properties['Voter.Power'];
                    const popupContent = `<div class="custom-popup">
                        <strong>${layerId === 'house' ? 'District' : 'State'}:</strong> ${name}<br>
                        <strong>Voter Power:</strong> ${voterPower}%
                    </div>`;

                    popup.setLngLat(e.lngLat).setHTML(popupContent).addTo(map);
                    map.getCanvas().style.cursor = 'pointer';
                } else {
                    if (hoveredStateId) {
                        map.setFeatureState({source: layerId, id: hoveredStateId}, { hover: false });
                        hoveredStateId = null;
                    }
                    map.getCanvas().style.cursor = '';
                    popup.remove();
                }
            });

            map.on('mouseleave', layerId + '-fill', function () {
                if (hoveredStateId) {
                    map.setFeatureState({source: layerId, id: hoveredStateId}, { hover: false });
                    hoveredStateId = null;
                }
                map.getCanvas().style.cursor = '';
                popup.remove();
            });

            // Update the current layer ID
            currentLayerId = layerId;
        }

        // Initial layer setup on map load
        map.on('load', function () {
            addGeoJsonLayer('presidential'); // Load presidential layer by default
            const geocoder = new MapboxGeocoder({
                accessToken: mapboxgl.accessToken,
                mapboxgl: mapboxgl,
                marker: false,
            });

        geocoder.on('result', function(e) {
                console.log(e.result.center)
    map.flyTo({
        
        center: e.result.center,
        zoom: 6.5  // Set this to whatever zoom level you prefer
    });
});
            document.getElementById('geocoder').appendChild(geocoder.onAdd(map));
        });

        document.getElementById('layer').addEventListener('change', function (e) {
            const value = e.target.value;
            if (value in layers) {
                addGeoJsonLayer(value);
            } else {
                Object.keys(layers).forEach(id => {
                    if (map.getLayer(id + '-fill')) {
                        map.removeLayer(id + '-fill');
                        map.removeLayer(id + '-line');
                        map.removeLayer(id + '-hover-line');  // Ensure hover line is also removed
                        map.removeSource(id);
                    }
                });
            }
        });
    </script>

        <div class= "container" id="state-lookup">
            <form action="/state" method="post">
                <label for="location">Pick a state to see high-impact elections</label>
                <select name="location" id="location">
                    {% for s in states %}
                        <option value="{{s}}">{{ s }}</option>
                    {% endfor %}
                </select>
                <button type="submit" class="btn btn-info">Find State Elections</button>
            </form>
        </div>

        <div class= "container" id="address-lookup">
            <form action="/local" method="post">
                <label for="location">Find Pivotal Elections near you</label>
                <input type="text" class="form-control" id="location" name="location"> </input>
                <button type="submit" class="btn btn-info">Find your Local Elections</button>
            </form>
        </div>

</body>
{% endblock %}
