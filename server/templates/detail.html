{% extends "layout.html" %}

<style> 
   body { margin: 0; padding: 0;  font-family: 'Arial';}
    .map-overlay {
        font: 14px/20px 'Arial';
        position: absolute;
        top: 100px; /* need a dynamic solution to keep it not overlaying with other stuff */
        left: 10px;
        bottom: 10px;
        padding: 10px;
        z-index: 2; /* put over  map */
    }
    .map-overlay-inner {
        background-color: rgba(0, 0, 0, 0.6);
        padding: 10px;
        border-radius: 3px;
        
    }
    .map-overlay-inner fieldset {
        border: none;
        padding: 0;
        margin: 0 0 10px;
    }
    .map-overlay-inner fieldset:last-child {
        margin: 0;
    }
    .map-overlay-inner select {
        width: 100%;
    }
    .map-overlay-inner label {
        display: block;
        font-weight: bold;
        display: block;
        margin-bottom: 5px;
    }
    .map-overlay-inner button {
        display: inline-block;
        width: 20px;
        height: 5px;
        border: none;
        cursor: pointer;
    }
    .map-overlay-inner button:focus {
        outline: none;
    }
    .custom-popup {
        font-size: 16px;
        padding: 10px;
        width: 200px;
        color: #000000;
        margin: 0px;
    
        
    }
    label[for="layer"],
    label[for="container"],
    label[for="location"] {
        color: rgb(230, 213, 213);
}
h2, h3 {
  color: rgb(230, 213, 213);
  font-family: 'Arial';
  text-align: center;
}

h3 {
  font-size: small;  
}

</style>

{% block main %}
<body>
    <div class="row">
        <div class="col">
            <ul class="list-group">
                <li class="list-group-item"> <strong>Presidential Race</strong>
                    <ul class="list-group list-group-flush">
                        {{ pres_list | safe }}
                    </ul>
                </li>
                <li class="list-group-item"> <strong>Senate</strong>
                    <ul class="list-group list-group-flush">
                        {{ senate_list | safe }}
                    </ul>
                </li>
                <li class="list-group-item"> <strong>House of Representatives</strong>
                    <ul class="list-group list-group-flush">
                        {{ house_list | safe }}
                    </ul>
                </li>
                <li class="list-group-item"> <strong>State Senate</strong>
                    <ul class="list-group list-group-flush">
                        {{ state_senate_list | safe }}
                    </ul>
                </li>
                <li class="list-group-item"> <strong>State House</strong>
                    <ul class="list-group list-group-flush">
                        {{ state_house_list | safe }}
                    </ul>
                </li>
                <li class="list-group-item"> Ballot Initiatives
                    <ul class="list-group list-group-flush">
                        {{ ballot_list | safe }}
                    </ul>
                </li>
            </ul>
        </div>
        
        <div class="col">
            <div class="map-overlay">
                <div class="map-overlay-inner">
                    <div id="geocoder" class="geocoder"></div>
                    <fieldset>
                        <label>Select your topic of interest</label>
                        <select id="layer" name="layer">
                            <option value="empty">choose</option>
                            <option value="presidential">Presidential race</option>
                            <option value="congressional">Senate race</option>
                            <option value="house">House race</option>
                            <option value="gubernatorial">State Governors</option>
                        </select>
                    </fieldset>
                </div>
            </div>
            <div class="map-container">
                <div id="map"></div>
            
                <script>
                    mapboxgl.accessToken = '{{ mapbox_key }}';
                    const map = new mapboxgl.Map({
                        container: 'map',
                        style: 'mapbox://styles/mikeklein1/clxkrmlob01s801qkb96q6c00',
                        center: [-98.625126, 37.718862],  // UPDATE FOR DYNAMIC STUFF
                        zoom: 3,  // UPDATE FOR DYNAMIC STUFF
                        projection: 'mercator'
                    });
                
                    const layers = {
            presidential: 'static/data/geojson_imports/test_geojson.geojson',
            congressional: 'static/data/geojson_imports/Congressional_power.geojson',
            house: 'static/data/geojson_imports/2024.house.VoterPower.geojson',
            gubernatorial: 'static/data/geojson_imports/gubernatorial.geojson'
        };

        let hoveredStateId = null; // This will hold the ID of the feature under the mouse.
        let currentLayerId = 'presidential'; // Track the current layer

        const popup = new mapboxgl.Popup({
            closeButton: false,
            closeOnClick: false
        });
        

        function addGeoJsonLayer(layerId) {
            const idProperty = layerId === 'house' ? 'GEOIDFQ' : 'STATEFP';  //  'house' uses GEOIDFQ, others use STATEFP for unique id

            // Clear hover state when switching layers
            if (hoveredStateId) {
                map.setFeatureState({source: currentLayerId, id: hoveredStateId}, { hover: false });
                hoveredStateId = null;
            }

            // Remove existing layers
            if (map.getSource(currentLayerId)) {
                map.removeLayer(currentLayerId + '-fill');
                map.removeLayer(currentLayerId + '-line');
                map.removeLayer(currentLayerId + '-hover-line');  // Remove hover line if it exists
                map.removeSource(currentLayerId);
            }

            // Add  layers
            map.addSource(layerId, {
                type: 'geojson',
                data: layers[layerId],
                promoteId: idProperty  
            });

            map.addLayer({
    id: layerId + '-fill',
    type: 'fill',
    source: layerId,
    paint: {
        'fill-color': [
            'case',
            ['==', ['get', 'Voter.Power'], null], '#D3D3D3', // Explicitly handle null values
            ['==', layerId, 'presidential'], [
                'interpolate', ['linear'], ['get', 'Voter.Power'],
                1, '#feedde', 10, '#fdbe85', 50, '#fd8d3c', 100, '#d94701'
            ],
            ['==', layerId, 'congressional'], [
                'interpolate', ['linear'], ['get', 'Voter.Power'],
                1, '#f2f0f7', 10, '#cbc9e2', 50, '#9e9ac8', 100, '#6a51a3'
            ],
            ['==', layerId, 'house'], [
                'interpolate', ['linear'], ['get', 'Voter.Power'],
                1, '#edf8e9', 10, '#bae4b3', 50, '#74c476', 100, '#238b45'
            ],
            ['==', layerId, 'gubernatorial'], [
                'match', ['get', 'Voter.Power'],
                'toss-up', '#ffff00',  
                'likely D', '#6aa4d3', 
                'safe D', '#1f78be', 
                'likely R', '#f77488',
                'safe R', '#ed1b30', 
                'no race', '#D3D3D3',
                '#D3D3D3' // Default color for any other unmatched string values
            ],
            '#D3D3D3'  // Default color for unmatched cases
        ],
        'fill-opacity': 1
    }
}, 'state-label');

            // line layer should be black as default
            map.addLayer({
                id: layerId + '-line',
                type: 'line',
                source: layerId,
                layout: {},
                paint: {
                    'line-color': '#000',
                    'line-width': 1,
                    'line-opacity': 1
                }
            });

            // add line layer that highlights when hovering 
            map.addLayer({
                id: layerId + '-hover-line',
                type: 'line',
                source: layerId,
                layout: {},
                paint: {
                    'line-color': ['case', ['boolean', ['feature-state', 'hover'], false], '#ffffff', '#000'],
                    'line-width': ['case', ['boolean', ['feature-state', 'hover'], false], 4, 2],
                    'line-opacity': ['case', ['boolean', ['feature-state', 'hover'], false], 1, 0]
                }
            });

            // put hover line  above others
            map.moveLayer(layerId + '-hover-line');

            // mouse event for hovering
            map.on('mousemove', layerId + '-fill', function (e) {
                if (e.features.length > 0) {
                    const feature = e.features[0];
                    const currentId = feature.properties[idProperty];  // Make sure this is the field you promote as ID

                   // console.log("Feature ID:", feature.id, "Current ID:", currentId);  // Logging feature ID for debugging

                    if (hoveredStateId !== currentId) {
                        if (hoveredStateId) {
                            map.setFeatureState({source: layerId, id: hoveredStateId}, { hover: false });
                        }
                        hoveredStateId = currentId;
                        map.setFeatureState({source: layerId, id: hoveredStateId}, { hover: true });
                    }

                    const name = feature.properties['NAME'] || feature.properties['NAMELSAD'];
                    const voterPower = feature.properties['Voter.Power'];
                    const cookRating = feature.properties['Voter.Power'];
                    const candidateNames = feature.properties['candidate_names'];

        let popupContent = '';

        if (layerId === 'gubernatorial') {
            popupContent = `<div class="custom-popup">
                <strong>State:</strong> ${name}<br>
                <strong>Cook Rating:</strong> ${cookRating}
            </div>`;
        } else if (layerId === 'presidential') {
           popupContent = `<div class="custom-popup">
              <strong>Presidential Candidates:</strong> ${candidateNames}
           </div>`;

          

        } else {
            popupContent = `<div class="custom-popup">
                <strong>${layerId === 'house' ? 'District' : 'State'}:</strong> ${name}<br>
                <strong>Voter Power:</strong> ${voterPower}%
            </div>`;
        }

            

                    popup.setLngLat(e.lngLat).setHTML(popupContent).addTo(map);
                    map.getCanvas().style.cursor = 'pointer';
                } else {
                    if (hoveredStateId) {
                        map.setFeatureState({source: layerId, id: hoveredStateId}, { hover: false });
                        hoveredStateId = null;
                    }
                    map.getCanvas().style.cursor = '';
                    popup.remove();
                }
            });

            map.on('mouseleave', layerId + '-fill', function () {
                if (hoveredStateId) {
                    map.setFeatureState({source: layerId, id: hoveredStateId}, { hover: false });
                    hoveredStateId = null;
                }
                map.getCanvas().style.cursor = '';
                popup.remove();
            });

            // Update the current layer ID
            currentLayerId = layerId;
        }

        

        // Initial layer setup on map load
        map.on('load', function () {
            addGeoJsonLayer('presidential'); // Load presidential layer by default

             //filter for only USA names
    const layers = map.getStyle().layers;

layers.forEach((layer) => {
    const currentFilters = map.getFilter(layer.id);
    
    // if layer includes label or state filter for USA
    if (layer.id.includes('label') || layer.id.includes('state') || layer.id.includes('admin')) {
        if (currentFilters) {
        
            map.setFilter(layer.id, ['all', currentFilters, ['==', ['get', 'iso_3166_1'], 'US']]);
        } else {
    
            map.setFilter(layer.id, ['==', ['get', 'iso_3166_1'], 'US']);
        }
    
    }

    
});
            
});
          

        document.getElementById('layer').addEventListener('change', function (e) {
            const value = e.target.value;
            if (value in layers) {
                addGeoJsonLayer(value);
            } else {
                Object.keys(layers).forEach(id => {
                    if (map.getLayer(id + '-fill')) {
                        map.removeLayer(id + '-fill');
                        map.removeLayer(id + '-line');
                        map.removeLayer(id + '-hover-line');  // Ensure hover line is also removed
                        map.removeSource(id);
                    }
                });
            }
        });
                </script>
            </div>
        </div>
    </div>

</body>


{% endblock %}
