{% extends "layout.html" %}

<style> 
   body { margin: 0; padding: 0;  font-family: 'Arial';}
    .map-overlay {
        font: 14px/20px 'Arial';
        position: absolute;
        top: 100px; /* need a dynamic solution to keep it not overlaying with other stuff */
        left: 10px;
        bottom: 10px;
        padding: 10px;
        z-index: 2; /* put over  map */
    }
    .map-overlay-inner {
        background-color: rgba(0, 0, 0, 0.6);
        padding: 10px;
        border-radius: 3px;
        
    }
    .map-overlay-inner fieldset {
        border: none;
        padding: 0;
        margin: 0 0 10px;
    }
    .map-overlay-inner fieldset:last-child {
        margin: 0;
    }
    .map-overlay-inner select {
        width: 100%;
    }
    .map-overlay-inner label {
        display: block;
        font-weight: bold;
        display: block;
        margin-bottom: 5px;
    }
    .map-overlay-inner button {
        display: inline-block;
        width: 20px;
        height: 5px;
        border: none;
        cursor: pointer;
    }
    .map-overlay-inner button:focus {
        outline: none;
    }
    .custom-popup {
        font-size: 16px;
        padding: 10px;
        width: 200px;
        color: #000000;
        margin: 0px;
    
        
    }
    label[for="layer"],
    label[for="container"],
    label[for="location"] {
        color: rgb(230, 213, 213);
}
h2, h3 {
  color: rgb(230, 213, 213);
  font-family: 'Arial';
  text-align: center;
}

h3 {
  font-size: small;  
}

</style>

{% block main %}
<body>
    <div class="row">
        <div class="col">
            <ul class="list-group">
                <li class="list-group-item"> <strong>Presidential Race</strong>
                    <ul class="list-group list-group-flush">
                        {{ pres_list | safe }}
                    </ul>
                </li>
                <li class="list-group-item"> <strong>Senate</strong>
                    <ul class="list-group list-group-flush">
                        {{ senate_list | safe }}
                    </ul>
                </li>
                <li class="list-group-item"> <strong>House of Representatives</strong>
                    <ul class="list-group list-group-flush">
                        {{ house_list | safe }}
                    </ul>
                </li>
                <li class="list-group-item"> <strong>State Senate</strong>
                    <ul class="list-group list-group-flush">
                        {{ state_senate_list | safe }}
                    </ul>
                </li>
                <li class="list-group-item"> <strong>State House</strong>
                    <ul class="list-group list-group-flush">
                        {{ state_house_list | safe }}
                    </ul>
                </li>
                <li class="list-group-item"> Ballot Initiatives
                    <ul class="list-group list-group-flush">
                        {{ ballot_list | safe }}
                    </ul>
                </li>
            </ul>
        </div>
        
        <div class="col">
            <div class="map-overlay">
                <div class="map-overlay-inner">
                    <div id="geocoder" class="geocoder"></div>
                    <fieldset>
                        <label>Select your topic of interest</label>
                        <select id="layer" name="layer">
                            <option value="empty">choose</option>
                            <option value="presidential">Presidential race</option>
                            <option value="congressional">Senate race</option>
                            <option value="house">House race</option>
                            <option value="gubernatorial">State Governors</option>
                            <option value="ballot_abort">Abortion ballot initiatives</option> 
                            <option value="ballot_sg">State government ballot initiatives</option> 
                            <option value="ballot_vpm">Voting policy measure ballot initiatives</option> 
                            <option value="ballot_others">Additional liberty ballot initiatives</option> 

                        </select>
                    </fieldset>
                </div>
            </div>
            <div class="map-container">
                <div id="map"></div>
            
                <script>
                    mapboxgl.accessToken = '{{ mapbox_key }}';
                    const map = new mapboxgl.Map({
                        container: 'map',
                        style: 'mapbox://styles/mikeklein1/clxkrmlob01s801qkb96q6c00',
                        center: [-98.625126, 37.718862],  
                        zoom: 6 ,  
                        projection: 'mercator'
                    });
                
                    const layers = {
            presidential: 'static/data/geojson_imports/geojson_final/president.geojson',
            congressional: 'static/data/geojson_imports/geojson_final/senate.geojson',
            house: 'static/data/geojson_imports/geojson_final/house.geojson',
            gubernatorial: 'static/data/geojson_imports/geojson_final/governor.geojson',
            ballot_abort: 'static/data/geojson_imports/ballot_abort.geojson',
            ballot_vpm: 'static/data/geojson_imports/ballot_VPM.geojson',
            ballot_sg: '/static/data/geojson_imports/ballot_sg.geojson',
            ballot_others: '/static/data/geojson_imports/ballot_other.geojson'


        };

        let hoveredStateId = null; // This will hold the ID of the feature under the mouse.
        let currentLayerId = 'presidential'; // Track the current layer

        const popup = new mapboxgl.Popup({
            closeButton: false,
            closeOnClick: false
        });
        

        function addGeoJsonLayer(layerId) {
            const idProperty = layerId === 'house' ? 'GEOIDFQ' : 'STATEFP';  //  'house' uses GEOIDFQ, others use STATEFP for unique id

            // Clear hover state when switching layers
            if (hoveredStateId) {
                map.setFeatureState({source: currentLayerId, id: hoveredStateId}, { hover: false });
                hoveredStateId = null;
            }

            // Remove existing layers
            if (map.getSource(currentLayerId)) {
                map.removeLayer(currentLayerId + '-fill');
                map.removeLayer(currentLayerId + '-line');
                map.removeLayer(currentLayerId + '-hover-line');  // Remove hover line if it exists
                map.removeSource(currentLayerId);
            }

            // Add  layers
            map.addSource(layerId, {
                type: 'geojson',
                data: layers[layerId],
                promoteId: idProperty  
            });

            map.addLayer({
    id: layerId + '-fill',
    type: 'fill',
    source: layerId,
    paint: {
        'fill-color': [
            'case',
            ['==', ['get', 'voter_power'], null], '#D3D3D3', // Handles null or undefined voter_power
            ['==', ['get', 'voter_power'], 0], '#D3D3D3', // Handles zero voter_power
            ['==', layerId, 'presidential'], // Condition
            ['interpolate', ['linear'], ['get', 'voter_power'], // Interpolation for presidential
            1, '#feedde', 33.3, '#fdbe85', 66.6, '#EF6548', 100, '#D7301F'],
            ['==', layerId, 'congressional'], // Condition
            ['interpolate', ['linear'], ['get', 'voter_power'], // Interpolation for congressional
                1, '#f2f0f7', 33.3, '#cbc9e2', 66.6, '#9e9ac8', 100, '#6a51a3'],
            ['==', layerId, 'house'], // Condition
            ['interpolate', ['linear'], ['get', 'voter_power'], // Interpolation for house
                1, '#edf8e9', 33.3, '#bae4b3', 66.6, '#74c476', 100, '#238b45'],
            ['==', layerId, 'gubernatorial'], // Condition
            ['interpolate', ['linear'], ['get', 'voter_power'], // Interpolation for house
                1, '#fffac2', 33.3, '#fff68f', 66.6, '#fff25c', 100, '#ffdc09'], 
            '#D3D3D3'  // Default color if no conditions are met
        ],
        'fill-opacity': 1
    }
}, 'state-label');



            // line layer should be black as default
            map.addLayer({
                id: layerId + '-line',
                type: 'line',
                source: layerId,
                layout: {},
                paint: {
                    'line-color': '#808080',
                    'line-width': .5,
                    'line-opacity': .8
                }
            });

            // add line layer that highlights when hovering 
            map.addLayer({
                id: layerId + '-hover-line',
                type: 'line',
                source: layerId,
                layout: {},
                paint: {
                    'line-color': ['case', ['boolean', ['feature-state', 'hover'], false], '#ffffff', '#000'],
                    'line-width': ['case', ['boolean', ['feature-state', 'hover'], false], 4, 2],
                    'line-opacity': ['case', ['boolean', ['feature-state', 'hover'], false], 1, 0]
                }
            });

            // put hover line  above others
            map.moveLayer(layerId + '-hover-line');

            // mouse event for hovering
            map.on('mousemove', layerId + '-fill', function (e) {
                if (e.features.length > 0) {
                    const feature = e.features[0];
                    const currentId = feature.properties[idProperty];  // Make sure this is the field you promote as ID

                   // console.log("Feature ID:", feature.id, "Current ID:", currentId);  // Logging feature ID for debugging

                    if (hoveredStateId !== currentId) {
                        if (hoveredStateId) {
                            map.setFeatureState({source: layerId, id: hoveredStateId}, { hover: false });
                        }
                        hoveredStateId = currentId;
                        map.setFeatureState({source: layerId, id: hoveredStateId}, { hover: true });
                    }

                    const name = feature.properties['NAME'] || feature.properties['NAMELSAD'];
                    const voterPower = feature.properties['voter_power'] === undefined ? 'no race' : feature.properties['voter_power'];
                    const voterPowerhouse = feature.properties['voter_power'];
                    const cookRating = feature.properties['voter_power'];
                    const candidateNameR = feature.properties['R_running'] || 'Not available';
                    const candidateNameD = feature.properties['D_running'] || 'Not available';


        let popupContent = '';

        if (layerId === 'gubernatorial') {
            popupContent = `<div class="custom-popup">
                <strong>State:</strong> ${name}<br>
                <strong>Republican running:</strong> ${candidateNameR}<br>
                <strong>Democrat running:</strong> ${candidateNameD}<br>
                <strong>Voter Power:</strong> ${voterPower}
            </div>`;
        } else if (layerId === 'presidential') {
           popupContent = `<div class="custom-popup">
              <strong>Republican running:</strong> ${candidateNameR}<br>
              <strong>Democrat running:</strong> ${candidateNameD}<br>
              <strong>Voter Power:</strong> ${voterPower}
           </div>`;

          

        } else {
            const displayVoterPower = voterPowerhouse === undefined ? 'no competitive race' : voterPowerhouse;

    popupContent = `<div class="custom-popup">
                <strong>${layerId === 'house' ? 'District' : 'State'}:</strong> ${name}<br>
                <strong>Republican running:</strong> ${candidateNameR}<br>
                <strong>Democrat running:</strong> ${candidateNameD}<br>
                <strong>Voter Power:</strong> ${displayVoterPower}
            </div>`;
        }

            

                    popup.setLngLat(e.lngLat).setHTML(popupContent).addTo(map);
                    map.getCanvas().style.cursor = 'pointer';
                } else {
                    if (hoveredStateId) {
                        map.setFeatureState({source: layerId, id: hoveredStateId}, { hover: false });
                        hoveredStateId = null;
                    }
                    map.getCanvas().style.cursor = '';
                    popup.remove();
                }
            });

            map.on('mouseleave', layerId + '-fill', function () {
                if (hoveredStateId) {
                    map.setFeatureState({source: layerId, id: hoveredStateId}, { hover: false });
                    hoveredStateId = null;
                }
                map.getCanvas().style.cursor = '';
                popup.remove();
            });

            // Update the current layer ID
            currentLayerId = layerId;
        }

        

        // Initial layer setup on map load
        map.on('load', function () {
    addGeoJsonLayer('presidential');
    
    //filter for only USA names
    const layers = map.getStyle().layers;

    layers.forEach((layer) => {
        const currentFilters = map.getFilter(layer.id);
        
        // if layer includes label or state filter for USA
        if (layer.id.includes('label') || layer.id.includes('state') || layer.id.includes('admin')) {
            if (currentFilters) {
                map.setFilter(layer.id, ['all', currentFilters, ['==', ['get', 'iso_3166_1'], 'US']]);
            } else {
                map.setFilter(layer.id, ['==', ['get', 'iso_3166_1'], 'US']);
            }
        }
    });
});

        document.getElementById('layer').addEventListener('change', function (e) {
            const value = e.target.value;
            if (value in layers) {
                addGeoJsonLayer(value);
            } else {
                Object.keys(layers).forEach(id => {
                    if (map.getLayer(id + '-fill')) {
                        map.removeLayer(id + '-fill');
                        map.removeLayer(id + '-line');
                        map.removeLayer(id + '-hover-line');  // Ensure hover line is also removed
                        map.removeSource(id);
                    }
                });
            }
        });
                </script>
            </div>
        </div>
    </div>

</body>


{% endblock %}
